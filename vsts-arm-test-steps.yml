steps:
- bash: |
   mkdir src
   git clone https://github.com/electron/electron src/electron
   # TODO: there's a subtle race condition here in that if you push two
   # commits to $BUILD_SOURCEBRANCH in quick succession, it's possible that
   # fetching the BUILD_SOURCEBRANCH ref will not actually fetch the
   # BUILD_SOURCEVERSION commit, and so the checkout will fail. Find a
   # better solution for checking out the commit to be built.
   (cd src/electron; git fetch origin +"${BUILD_SOURCEBRANCH}"; git checkout "${BUILD_SOURCEVERSION}")
  displayName: 'Setup directories'

- bash: |
   export ZIP_DEST=$PWD/src/out/Default
   mkdir -p $ZIP_DEST
   cd src/electron
   npm install
   node script/download-circleci-artifacts.js --buildNum=$CIRCLE_BUILD_NUM --name=dist.zip --dest=$ZIP_DEST
   cd $ZIP_DEST
   unzip -o dist.zip
  displayName: 'Download and unzip dist files for test'
  env:
    CIRCLE_TOKEN: $(CIRCLECI_TOKEN)

- bash: |
   export NODE_HEADERS_DEST=$PWD/src/out/Default/gen
   mkdir -p $NODE_HEADERS_DEST
   cd src/electron
   node script/download-circleci-artifacts.js --buildNum=$CIRCLE_BUILD_NUM --name=node_headers.tar.gz --dest=$NODE_HEADERS_DEST
   cd $NODE_HEADERS_DEST
   tar xzf node_headers.tar.gz
  displayName: 'Download and untar node header files for test'
  env:
    CIRCLE_TOKEN: $(CIRCLECI_TOKEN)

- bash: |
    sh -e /etc/init.d/xvfb start
  displayName: Setup for headless testing
  env:
    DISPLAY: 99.0

- bash: |
   cd src
   export ELECTRON_OUT_DIR=Default
   (cd electron && npm run test -- --ci --enable-logging)
  displayName: 'Run Electron tests'

- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFiles: '*.xml'

    searchFolder: '$(System.DefaultWorkingDirectory)/src/junit/'

  condition: succeededOrFailed()
